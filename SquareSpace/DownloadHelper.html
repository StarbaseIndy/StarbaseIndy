<html>
  <head>
    <title>Squarespace Detailed Order Download Helper</title>

    <script>
      // Why download this way?  Because the SquareSpace Commerce API costs extra.
      // https://developers.squarespace.com/commerce-api

      // How to get this Square info?
      // 1. Navigate to SquareUp => Sales => Transactions
      // 2. Select date 12/01/2017-12/01/2018
      // 3. Select location "SBI" only
      // 4. In Chrome Developer Tools (F12), view the page Elements, search for "_blank", and replace with "_self"
      // 5. In Chrome Developer Tools (F12), select Network tab, and click the "Preserve Logs" checkbox
      // 6. Click the "Export" button, and select "Transactions CSV"
      // 7. In Chrome Developer Tools (F12), in the Network tab, look at the "transactions.csv" network call form data.
      function getSquareUrl(type, startDate, endDate, locationToken) {
        const startTimestamp = (new Date(startDate + 'T00:00:00.000-0500')).getTime() * 1000;
        const endTimestamp = (new Date(endDate + 'T00:00:00.000-0500')).getTime() * 1000;
        const postData = {
          user_token: { 'merchant_token': 'SFTBA37WGJXWY', unit_token: [locationToken] },
          time_range_params: {
            batch_request: { batch_size: 5000 }, // TODO: needed?
            ordered_time_range: {
              begin_time: { instant_usec: startTimestamp },
              end_time: { instant_usec: endTimestamp },
              sort_order: "DESC",
              tz_name: "America/New_York"
            },
          },
        };
        return 'https://squareup.com/v2/reports/' + type + '.csv?beemo_request=' + encodeURIComponent(JSON.stringify(postData));
      }
      
      function get2017SquareUrl(type) {
        // Note: 2018 vendors are also invoiced from this location
        const the_starbase = '21PTCF9NNTCRJ';
        return getSquareUrl(type, '2017-11-24', '2017-11-27', the_starbase);
      }

      function get2018SquareUrl(type) {
        const sbi = 'WR6MC29WH0P5Z'
        return getSquareUrl(type, '2017-12-01', '2018-12-01', sbi);
      }
      
      function getSquareSpaceUrl(productId = '') {
        return 'https://heather-cottingham-r34y.squarespace.com/api/commerce/orders/export' +
               '?orderStates=PENDING' +
               '&productType=' +
               '&includeProductForm=' + (productId ? 'true' : 'false') +
			         '&productId=' + productId;
      }
      
      function get2018SquareSpaceUrl(productId) {
        return getSquareSpaceUrl(productId) +
               '&orderSubmittedOnMin=' + encodeURIComponent('2018-04-20T00:00:00.000Z') +
               '&orderSubmittedOnMax=' + encodeURIComponent('2018-11-23T00:00:00.000Z');
      }
      
      function onLoad() {
        // 2017
        document.getElementById('2017Transactions').href = get2017SquareUrl('transactions');
        document.getElementById('2017Items').href = get2017SquareUrl('items');
        
        // 2018
        document.getElementById('2018BadgeWeekend').href = get2018SquareSpaceUrl('5a9af8dbec212db87d180a40');
        document.getElementById('2018BadgeStar').href = get2018SquareSpaceUrl('5a9afc808165f55874292791');
        document.getElementById('2018BadgeSaturday').href = get2018SquareSpaceUrl('5a9aff4a0d9297b12545dd96');
        document.getElementById('2018BadgeChild').href = get2018SquareSpaceUrl('5a9b05e5c830255b24337e84');
        document.getElementById('2018BadgeSunday').href = get2018SquareSpaceUrl('5a9b05cc71c10b1a7d192bb4');
        document.getElementById('2018BadgeStudent').href = get2018SquareSpaceUrl('5b43fe24aa4a9907985a6406');
        document.getElementById('2018BadgeShopping').href = get2018SquareSpaceUrl('5a9b018af9619a44982d5255');
        document.getElementById('2018Summary').href = get2018SquareSpaceUrl(); 

        document.getElementById('2018MerchTeeShirt').href = get2018SquareSpaceUrl('5baabb389140b7701afad52d');
        document.getElementById('2018MerchVeeNeck').href = get2018SquareSpaceUrl('5bd0ffe9ec212d8c62dfe566');
        document.getElementById('2018MerchHoodie').href = get2018SquareSpaceUrl('5baabbdc71c10b96e750610a');
        document.getElementById('2018MerchPhotoOps').href = get2018SquareSpaceUrl('5baac1df71c10b96e750a30b');

        // DWTS: Gimpel: N/A
        document.getElementById('2018DWTSChau').href = get2018SquareSpaceUrl('5a9affc0e2c48369e01066ce');
        document.getElementById('2018DWTSBlair').href = get2018SquareSpaceUrl('5ba1881d40ec9a5482934510');
        document.getElementById('2018DWTSMagnus').href = get2018SquareSpaceUrl('5ba18ab94fa51aba30387d1d');
        document.getElementById('2018DWTSMacdonald').href = get2018SquareSpaceUrl('5ba18a01575d1f0b2b265823');
        document.getElementById('2018DWTSKlingon').href = get2018SquareSpaceUrl('5ba18cc84ae23767f1671f67');

        const vendorSheet2018 = 'https://docs.google.com/spreadsheets/d/1u81KrU4Vn6HFzaq4en40Llrv77q4pZ1RRC0WVgtMDME/export?format=csv&gid=1515616034';
        document.getElementById('2018BadgeVendor').href = vendorSheet2018;

        document.getElementById('2018Transactions').href = get2018SquareUrl('transactions');
        document.getElementById('2018Items').href = get2018SquareUrl('items');
        
        // 2019
        // TODO: add next year href initialization here.
      }  
    </script>
  </head>
  <body onload="onLoad()">
    <h1>Square/Squarespace/Drive Data Download Helper</h1>
    <h3>Instructions:</h3>
    <ul>
      <li>Log into <a target="_blank" href="https://heather-cottingham-r34y.squarespace.com/config">SBI SquareSpace</a> (will open in new tab)</li>
      <li>Log into <a target="_blank" href="https://drive.google.com/drive/u/1/folders/16nKCDo2RRU2M6T502mD1Rl38nOW3R2fm">SBI Google Drive</a> (will open in new tab)</li>
      <li>Log into <a target="_blank" href="https://squareup.com/login">Square</a> (will open in new tab)</li>
      <li>Right-click each link below, and select 'Save link as...'</li>
      <li>Rename the file before saving</li>
    </ul>

    <a href="#" id="2017Transactions"  >2017 Square Transactions</a> (Square)<br/>
    <a href="#" id="2017Items"         >2017 Square Detailed Items</a> (Square)<br/>
    <br/>
    <a href="#" id="2018BadgeChild"    >2018 Badge Child.csv</a><br/>
    <a href="#" id="2018BadgeSaturday" >2018 Badge Saturday.csv</a><br/>
    <a href="#" id="2018BadgeShopping" >2018 Badge Shopping.csv</a><br/>
    <a href="#" id="2018BadgeStar"     >2018 Badge Star.csv</a><br/>
    <a href="#" id="2018BadgeStudent"  >2018 Badge Student.csv</a><br/>
    <a href="#" id="2018BadgeSunday"   >2018 Badge Sunday.csv</a><br/>
    <a href="#" id="2018BadgeVendor"   >2018 Badge Vendor.csv</a> (Google Drive)<br/>
    <a href="#" id="2018BadgeWeekend"  >2018 Badge Weekend.csv</a><br/>
    <br/>
    <a href="#" id="2018DWTSBlair"     >2018 DWTS Blair.csv</a><br/>
    <a href="#" id="2018DWTSChau"      >2018 DWTS Chau.csv</a><br/>
    <a href="#" id="2018DWTSKlingon"   >2018 DWTS Klingon.csv</a><br/>
    <a href="#" id="2018DWTSMacdonald" >2018 DWTS Macdonald.csv</a><br/>
    <a href="#" id="2018DWTSMagnus"    >2018 DWTS Magnus.csv</a><br/>
    <br/>
    <a href="#" id="2018MerchHoodie"   >2018 Merch Hoodie.csv</a><br/>
    <a href="#" id="2018MerchPhotoOps" >2018 Merch Photo Ops.csv</a><br/>
    <a href="#" id="2018MerchTeeShirt" >2018 Merch Tee Shirt.csv</a><br/>
    <a href="#" id="2018MerchVeeNeck"  >2018 Merch Vee Neck Tee.csv</a><br/>
    <br/>
    <a href="#" id="2018Summary"       >2018 Summary.csv</a><br/>
    <br/>
    <a href="#" id="2018Transactions"  >2018 Square Transactions</a> (Square)<br/>
    <a href="#" id="2018Items"         >2018 Square Detailed Items</a> (Square)<br/>
   </body>
</html>

